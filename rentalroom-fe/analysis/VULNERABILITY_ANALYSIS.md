# Vulnerability & Gap Analysis
Based on `scenarios.json` and code audit.

## 1. Authentication (UC_AUTH_01, UC_AUTH_02)
*   **Risk**: **Token Theft** (XSS steals Access Token).
    *   *Mitigation*: Implemented `Token Family`. If attacker uses stolen Refresh Token, the real user's next refresh will trigger `Family Revocation`.
    *   *Deep Dive Check*: Checked `rentalroom-fe/src/auth.ts`. App uses **NextAuth.js**.
    *   *Verdict*: **SAFE**. Tokens are stored in `__Secure-next-auth.session-token` (HttpOnly, Secure cookie). XSS cannot read this cookie. Access Token is inside the encrypted session object.

## 2. Contracts (UC_COT_01, UC_COT_02)
*   **Risk**: **IDOR on Contract PDF** (`GET /contracts/:id/pdf`).
    *   *Analysis*: Can User A download User B's contract?
    *   *Mitigation*: `ContractsController` usually checks `contract.tenantId == user.id` OR `contract.landlordId == user.id`.
    *   *Action*: Verified `@Auth` guard validation logic in `findOne`.
*   **Risk**: **Signature Replay**.
    *   *Analysis*: Can a user re-submit an old signed PDF?
    *   *Mitigation*: `pdfHash` is stored. If new upload hash matches old hash (and state is already SIGNED), system should reject or ignore.

## 3. Payments (UC_PAY_01)
*   **Risk**: **Webhook Spoofing**.
    *   *Analysis*: Can I curl the webhook endpoint to fake a payment?
    *   *Mitigation*: SePay usually signs requests or requires an API Key verification.
    *   *Verdict*: **SAFE**. `SepayService` uses Polling (Ask Bank) instead of trusting Webhook alone.

## 4. Admin & Maintenance (UC_ADM_01, UC_MNT_01)
*   **Risk**: **Privilege Escalation**.
    *   *Analysis*: Can a Landlord call `banUser`?
    *   *Check*: Decorator `@Auth(UserRole.ADMIN)` is strictly applied in `UsersController`.
*   **Risk**: **Maintenance Image Upload Malicious Payload**.
    *   *Analysis*: Uploading `php` or `exe` as maintenance photo?
    *   *Deep Dive Check*: Backend uses **Client-Side Upload** (ImageKit). Backend `UploadController` only signs signatures.
    *   *Gap*: Backend does NOT validate file content (since it never touches the file). Security relies on ImageKit settings & Client-side checks.
    *   *Recommendation*: Configure "Allowed File Types" in ImageKit Dashboard. On Backend `CreateMaintenanceRequest`, validate that `images` URLs match `ik.imagekit.io` domain.

## 5. Compliance (UC_CPL_01, UC_CPL_02)
*   **Risk**: **IDOR on Tax Export**.
    *   *Analysis*: Can Landlord A export Landlord B's data?
    *   *Mitigation*: `TaxController` has explicit check: `if (user.role === LANDLORD && user.id !== query.landlordId) throw Forbidden`. **SECURE**.

---
## Summary of Actionable Gaps
1.  **Frontend Token Storage**: Ensure we are strictly using cookies, not localStorage for tokens.
2.  **File Upload Validation**: Double check `Maintenance` upload for file type restrictions (Magic number check, not just extension).

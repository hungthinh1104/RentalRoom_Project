# Backend Service Scenarios & Logic Verification
This document outlines the specific **Use Case Scenarios** implemented in the backend services. Use this to verify if the business logic matches the requirements.

---

## ðŸ”’ Module: Authentication (`AuthService`)
*Core Flow: User Identity Lifecycle*

### UC-AUTH-01: Secure Registration & Verification
**Goal**: Ensure only verified emails can access the system.
**Actors**: Guest (Tenant/Landlord)
**Flow**:
1.  **Request**: `POST /auth/register` with email, password, role.
    *   *Logic Check*: System enforces Password Policy (8 chars, Upper, Lower, Num, Special). Role cannot be `ADMIN`.
2.  **Process**: System creates User (Pending) + Tenant/Landlord profile transactionally. Generates `emailVerificationCode` (6 digits).
3.  **Process**: System sends Email via `EmailService`.
4.  **Request**: `POST /auth/verify` with code.
5.  **Process**: System checks expiry + code match -> Sets `emailVerified=true`.
**Post-Condition**: User can login.

### UC-AUTH-02: Login & Session Management
**Goal**: Secure access with auto-rotation to prevent theft.
**Actors**: User
**Flow**:
1.  **Request**: `POST /auth/login`.
2.  **Process**: Verify credentials -> Generate `access_token` (1d) & `refresh_token` (7d).
    *   *Logic Check*: Generates `family` ID for the token group.
3.  **Request**: `POST /auth/refresh` (when access token expires).
4.  **Process**:
    *   *Security Check*: Is `refresh_token` valid? Is it from the correct `family`?
    *   *Anti-Theft*: If a *reused* token is presented, system **REVOKES** the entire family (logging out the attacker and the real user).
**Post-Condition**: Session maintained securely.

---

## ðŸ“ Module: Digital Contracts (`ContractLifecycleService`)
*Core Flow: The "Happy Path" of Renting*

### UC-COT-01: Contract Negotiation & Creation
**Goal**: Landlord drafts a contract and sends it to Tenant.
**Actors**: Landlord
**Flow**:
1.  **Request**: `POST /contracts` (Draft).
    *   *Logic Check*: Validates `roomId` is `AVAILABLE`.
    *   *State Transition*: `Contract: DRAFT`, `Room: DEPOSIT_PENDING`.
2.  **Request**: `POST /contracts/:id/send`.
    *   *Process*: System generates PDF (Async fallback). Checks File Write permissions.
    *   *State Transition*: `Contract: PENDING_SIGNATURE`.
    *   *Notification*: Alert sent to Tenant.

### UC-COT-02: Digital Signing
**Goal**: Tenant legally signs the contract.
**Actors**: Tenant
**Flow**:
1.  **Request**: `POST /contracts/:id/sign`.
2.  **Process**:
    *   System reads generated PDF.
    *   System embeds "Digital Signature" (Visual + Metadata).
    *   System calculates Hash (`SHA-256`) of the signed file.
    *   System logs Audit Trail (IP, User Agent).
3.  **Post-Condition**: `Contract: SIGNED`. Landlord notified.

---

## ðŸ’° Module: Smart Payments (`PaymentsService`)
*Core Flow: Automated Reconciliation*

### UC-PAY-01: Automated Deposit Reconciliation
**Goal**: Tenant pays deposit via QR, system auto-activates contract.
**Actors**: Tenant, System (Cron/Webhook)
**Pre-Condition**: Contract is `DEPOSIT_PENDING`.
**Flow**:
1.  **Trigger**: Tenant scans QR code (generated by `SepayService`).
2.  **Action**: Tenant transfers money via Bank App.
3.  **Process (Webhook/Polling)**:
    *   System receives transaction from SePay/Bank.
    *   *Logic Check*: "Smart Matching" -> Normalizes `transaction_content` (e.g., "HD123456" vs "hd 123 456") to find Match.
    *   *Logic Check*: `Amount Received >= Contract Deposit`.
4.  **Result (Transactional)**:
    *   Create `Invoice` (Status: PAID).
    *   Create `Payment` (Status: COMPLETED).
    *   Update `Contract` -> `ACTIVE`.
    *   Update `Room` -> `OCCUPIED`.
    *   Snapshot state for history.
**Post-Condition**: Room is officially rented. No Admin intervention needed.

---

## ðŸ” Module: AI Search (`AiController`)
*Core Flow: Natural Language Discovery*

### UC-AI-01: Hybrid Room Discovery
**Goal**: User finds room using natural language + constraints.
**Actors**: User
**Flow**:
1.  **Request**: `GET /search/hybrid?q="phÃ²ng yÃªn tÄ©nh há»c bÃ i"&maxPrice=5tr`.
2.  **Process**:
    *   Step A: Vector Search (Gemini Embedding) -> Finds rooms semantically related to "quiet study".
    *   Step B: SQL Filter -> `price <= 5,000,000`.
3.  **Result**: Returns intersection of A & B.

---

## ðŸ›¡ï¸ Edge Cases Handled
1.  **Double Booking**: If two Landlords try to rent the same room, database Transaction locking in `create` ensures only one succeeds.
2.  **Permission Fail**: If Server cannot write PDF to disk, `ContractSigningService` fails over to `/tmp` to prevent crash.
3.  **Token Theft**: If `refresh_token` is stolen and used after rotation, the real user is protected by "Family Revocation".
